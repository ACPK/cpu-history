<HTML>	<HEAD>		<META http-equiv="content-type" content="text/html;charset=Shift_JIS">		<META name="AppleTitle" content="Memory Monitor ヘルプ">		<META name="AppleIcon" content="Help/MemoryMonitor.gif">		<META name="AppleFont" content="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">		<META name="AppleSearchResultsFont" content="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">		<TITLE>Memory Monitor ヘルプ</TITLE>	</HEAD>	<BODY>		<H4><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">Mac OS X のメモリ管理</FONT>		</H4>		<FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">CPU モニタ（Mac OS X 10.3 以降ではアクティビティモニタ）が CPU の動作状況を表示するように、Memory Monitor は Mac OS X システムのメモリの使用状況を表示します。しかし、Memory Monitor が Dock アイコンに表示するグラフを理解するためには、Mac OS X のメモリ管理についての基本的な理解が必要です。しかも Mac OS X は Unix ライクなオペレーティングシステムである Darwin をベースにしているため、このヘルプは Unix の仮想メモリ管理に関するちょっとしたチュートリアルになってしまいます。でもご心配なく。Mac のパワーユーザはこうした知識を欲しがりますが、通常の Mac ユーザにとっては知っておく必要はありません。さて、現在 Mac 上で動作しているプロセス（アプリケーションやシステムタスク）をモニタしたい場合には、通常はプロセスビューア（Mac OS X 10.3 以降ではアクティビティモニタ）を使います。Unix でこれに相当するのは &laquo;top&raquo; というコマンドラインツールです。&laquo;top&raquo; を実行すると（ターミナルウインドウで &laquo;top&raquo; とタイプ入力するだけです）、ヘッダーブロックに次のようなメモリ関連情報が含まれているのがおわかりいただけるでしょう：</FONT>		<PRE>PhysMem: 50M wired, 194M active, 181M inactive, 425M used, 23M free		</PRE>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">Mac OS 9 の &laquo;この Macintosh について&raquo; ダイアログボックスに表示されるメモリ使用状況情報に比べると非常にわけのわからないこの情報を、Memory Monitor はグラフィカルに表示するのです。しかし、これの意味するところはいったい何でしょう？</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">物理メモリのうち 50MBが &laquo;wired&raquo; となっています。これは物理メモリ上で固定的に確保され、仮想メモリマネージャによってディスク上に書き出されることのない領域です。Memory Monitor の Dock アイコンでは、wired メモリのサイズはいちばん下のバーで表示されます。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">物理メモリのうち 194MB はアプリケーションやシステムソフトウェアによって使用されていますが、必要に応じてディスク上に書き出すことができます。この領域は &laquo;active&raquo; と呼ばれ、Memory Monitor の Dock アイコンでは下から 2 番目のバーで表示されます。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">物理メモリのうち 181MB には何らかのデータが入っていますが、実際には使用されていません。Unix はメモリの解放に関しては怠け者で、このような領域にはとりあえず &laquo;inactive&raquo; とマークしておくだけで、実際に必要とされるまでは解放しません。場合によってはこの領域が再び &laquo;active&raquo; になることがあります。例えば、つい先ほど終了したアプリケーションのコードがここに残っていて、再びそのアプリケーションを起動した場合などです。試してみるとわかりますが、これによりプログラムの起動が速くなります：アプリケーションを初めて起動する時の方が、2 回目以降の起動時よりも時間がかかります。メモリの inactive 領域は、サイズが動的に増減するディスクキャッシュのような働きをするのです。Memory Monitor の Dock アイコンでは下から 3 番目のバーで表示されます。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">425MB というのは wired、active、inactive メモリの合計です。これ以外の物理メモリ領域は free （空き）ということになります。例えば 448MB の RAM を搭載した Mac の場合なら、free メモリは 23MB になります。この 23MB には、システムが何らかの目的に利用できるようなデータはいっさい入っていません。free メモリの容量は、Memory Monitor の Dock アイコンではいちばん上のバーで表示されます。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">このことから、一見する限りではこの例の Mac は非常にいい状態にあるといえます。プログラムからの要求を満足できるだけの物理メモリがあり、また inactive メモリのサイズも大きく、キャッシュされた内容を無視しさえすれば free メモリの代わりに再利用できるからです。さらに &laquo;vm_stat&raquo; コマンドラインツールを使えば、より詳細な情報を得ることができます：</FONT>		<PRE>[cube:~] bb% vm_statMach Virtual Memory Statistics: (page size of 4096 bytes)Pages free:                     1412.Pages active:                  51879.Pages inactive:                48646.Pages wired down:              12751."Translation faults":       61836589.Pages copy-on-write:         2947749.Pages zero f<!--to avoid a ligature-->illed:          18373114.Pages reactivated:           2144395.Pageins:                      504520.Pageouts:                      95093.Object cache: 512547 hits of 2355002 lookups (21% hit rate)		</PRE>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">これらは何を意味しているのでしょう？ここにすべて書き出すよりも、まずは自分で調べてみましょう：ターミナルウインドウで &laquo;man vm_stat&raquo; とタイプ入力してみてください。Unix の &laquo;man&raquo; は、そのコマンドのマニュアルページを表示するコマンドです。（&laquo;man&raquo; の使い方を知りたいなら、 &laquo;man man&raquo; をお試しください。）</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">しかし、vm_stat の出力のうちの 1 項目については説明しておかねばなりません：&laquo;page ofmemory&raquo; とは何でしょう？Unix ではメモリを &laquo;page&raquo; という単位に分割します。page（ページ）とは、仮想メモリマネージャによってあちこち移動させることが可能な、メモリの最小単位です。Mac OS X では、1 page のサイズは4KB です。また、ページは移動可能なメモリの最小単位であるため、メモリ上の内容をディスクへと書き出す作業のことを &laquo;page out&raquo;（ページアウト）、ページをディスクから物理メモリ上に読み込む作業のことを &laquo;page in&raquo;（ページイン）と呼びます。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">vm_stat にはもうひとつ面白い使い方があります。秒単位で間隔を指定し、情報を逐次更新することができるのです：</FONT>		<PRE>[cube:~] bb% vm_stat 1Mach Virtual Memory Statistics: (page size of 4096 bytes, cache hits 21%)  free active  inac  wire   faults     copy zerof<!--to avoid a ligature-->ill reactive  pageins  pageout  2537  51832 47518 12801 61816392  2947715 18369682  2144360   504233    95093  2537  51832 47518 12801       68        0        3        0        0        0  2537  51832 47518 12801       71        0        3        0        0        0  2537  51832 47518 12801       68        0        3        0        0        0  2537  51832 47518 12801       68        0        3        0        0        0  2537  51832 47518 12801       68        0        3        0        0        0^C		</PRE>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">上記は 1 秒ごとに更新するよう指定した例です。ctrl-C（&laquo;break&raquo; コマンド）で停止されています。（Unix のコマンドラインでは、ctrl-C は Mac の GUI における command-"." に相当し、実行中の動作をキャンセルします。）</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">vm_stat の最初の行は、ここではとりあえず無視します。最初の行は要約にすぎず、興味深いのはほかの行なのです。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">&laquo;pageins&raquo; 欄と &laquo;pageout&raquo; 欄に注目してください。これらは、毎秒どれだけのメモリページがディスクからページインまたはディスクへページアウトしているかを示します。これらの数値は Memory Monitor の Dock アイコン上では 2 種類の追加グラフとして描画されます。（ページングが行われていないときは、これらのグラフはアイコンの上部と下部に水平線として表示されます。）また、Dock アイコン上にページイン／ページアウトの回数を数値として表示することもできます。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">ページインは 2 つの理由により発生します：新規プログラムを起動するときには、ディスク上のプログラムファイルからプログラムのコードがページインされます。または、メモリに空き領域を確保するためにディスクに書き出されていたすでに動作中のプログラムが、メモリにアクセスするときにも起こります。Unix システムはページインをプログラム読み込み時に利用するため（これがいわゆる &laquo;demand paging&raquo; です）、ページインは必ず発生し、回避することはできません。また、ページインの頻度が高いとしても、それは物理メモリが足りないことを示すものではありません。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">ページアウトは物理メモリを使い果たしたときに発生します。プログラムを終了しても、他の目的のためにメモリを空ける必要が生じたときや同じプログラムを再起動するときまでは、プログラムのコードはメモリ上に残っています。したがって、システムがページアウトを開始したということは、物理メモリが足りなくなったということなのです。せっせと稼働している Unix システムでは、少々のページアウトは常識の範囲内です。しかし、よく使うアプリケーションのセットを動作させているとページアウトが恒常的に発生する（その結果ページインも恒常的に発生する）ような場合には、Macintosh に物理メモリを追加すれば、システムのパフォーマンスが大幅に改善されます。		</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">毎秒多数のページイン／ページアウトが発生しているような場合は、明らかに問題があります。メモリが対応できる範囲をはるかに超えた処理が行われており、仮想メモリとのやり取りでディスクがのたうち回っているのです（ディスクの動作ノイズが聞こえませんか！）。通常の使い方をしている限り、モダンな Unix システムがメモリを使い果たしてしまうようなことは滅多にありません。このような事態はプログラムの“メモリーリーク”、つまりメモリを一切解放せず永続的に消費するバグによって引き起こされるのです。このような場合、ディスクのガリガリ音とマシンの速度低下に皆うんざりしてしまいます。しかしこれは、システムがメモリを消費し切ってしまったのが原因ではありません。仮想メモリが有効に機能する範囲を超えてしまったことが原因なのです。</FONT>		<P><FONT face="ヒラギノ角ゴ Pro W3,MS Pゴシック,Osaka">以上は Unix の仮想メモリ管理についてのごく短い概略にすぎません。詳細はもっと複雑です。しかし、Memory Monitor を Mac OS X システムのパフォーマンス表示に利用するために必要な情報はおわかりいただけたかと思います。ご質問がありましたら作者までどうぞ；メールアドレスは “Memory Monitor について”にあります。</FONT>	</BODY></HTML>